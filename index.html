<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eXey Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <style>
    :root{--bg:#0b0b0b;--panel:#121212;--panel-2:#151515;--accent:#9ea3a8;--text:#d7d7d7;--muted:#909396;--success:#7fbf7f;--error:#d46b6b;--border:#262626;--soundcloud:#ff5500}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{background:var(--bg);color:var(--text);font-family:monospace;display:flex;justify-content:center;align-items:center;padding:16px;line-height:1.25;position:relative}
    .animated_background{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
    .bg_blob{position:absolute;border-radius:50%;filter:blur(80px);opacity:0.15;will-change:transform,opacity}
    .blob1{width:300px;height:300px;background:radial-gradient(circle,#9ea3a8 0%,transparent 70%);top:20%;left:10%}
    .blob2{width:400px;height:400px;background:radial-gradient(circle,#7fbf7f 0%,transparent 70%);bottom:10%;right:15%}
    .blob3{width:350px;height:350px;background:radial-gradient(circle,#909396 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%)}
    .container{width:100%;max-width:900px;position:relative;z-index:1;max-height:calc(100vh - 32px);overflow-y:auto}
    .center_box{background:rgba(18,18,18,0.85);backdrop-filter:blur(10px);border:1px solid var(--border);padding:20px;position:relative}
    .app-title{color:var(--accent);font-weight:700;font-size:20px;letter-spacing:0.6px;margin-bottom:6px;text-transform:uppercase}
    .app-subtitle{color:var(--muted);font-size:12px;margin-bottom:18px}
    .search_container{margin-bottom:14px}
    .search_input{width:100%;background:var(--panel-2);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:monospace;font-size:13px}
    .search_input:focus{outline:none;border-color:var(--accent)}
    .search_input::placeholder{color:var(--muted)}
    .soundcloud_container{margin-bottom:14px;background:var(--panel-2);border:1px solid var(--border);padding:12px}
    .soundcloud_header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .soundcloud_header h3{color:var(--soundcloud);font-size:13px;font-weight:700;margin:0}
    .soundcloud_badge{background:var(--soundcloud);color:#fff;font-size:9px;padding:2px 6px;font-weight:700}
    .soundcloud_input_row{display:flex;gap:8px}
    .soundcloud_input{flex:1;background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:monospace;font-size:12px}
    .soundcloud_input:focus{outline:none;border-color:var(--soundcloud)}
    .soundcloud_input::placeholder{color:var(--muted)}
    .soundcloud_btn{background:var(--soundcloud);border:1px solid var(--soundcloud);color:#fff;padding:10px 16px;font-size:11px;cursor:pointer;font-family:monospace;font-weight:700;white-space:nowrap}
    .soundcloud_btn:hover{background:#e64d00}
    .soundcloud_btn:disabled{opacity:0.5;cursor:not-allowed}
    .soundcloud_hint{color:var(--muted);font-size:11px;margin-top:8px}
    .library_container{margin-bottom:18px;background:var(--panel-2);border:1px solid var(--border);padding:8px}
    .library_header{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
    .library_header h2{color:var(--accent);font-size:14px;font-weight:700;margin:0}
    .library_header_right{display:flex;gap:8px;align-items:center}
    .library_stats{color:var(--muted);font-size:12px;padding:4px 8px;border:1px solid var(--border)}
    .clear_library_btn{background:var(--panel);border:1px solid var(--border);color:var(--error);padding:4px 8px;font-size:11px;cursor:pointer;font-family:monospace}
    .clear_library_btn:hover{background:var(--bg)}
    .track_list{max-height:320px;overflow-y:auto;background:var(--panel);border:1px solid var(--border);margin-top:8px}
    .track_item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;background:transparent}
    .track_item:last-child{border-bottom:none}
    .track_item:hover{background:var(--panel-2)}
    .track_item.active{background:var(--panel-2);border-left:3px solid var(--accent)}
    .track_item.soundcloud_track{border-left:3px solid var(--soundcloud)}
    .track_item.soundcloud_track.active{border-left:3px solid var(--soundcloud)}
    .track_art{width:44px;height:44px;background:var(--panel-2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--accent);flex-shrink:0;font-weight:700;overflow:hidden}
    .track_art img{width:100%;height:100%;object-fit:cover}
    .track_art.soundcloud_art{color:var(--soundcloud);border-color:var(--soundcloud)}
    .track_info{flex:1;min-width:0}
    .track_title{color:var(--text);font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track_artist{color:var(--muted);font-size:12px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track_album{color:var(--muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track_duration{color:var(--muted);font-size:12px;flex-shrink:0;margin-left:10px;min-width:40px;text-align:right}
    .track_source{font-size:9px;padding:2px 4px;background:var(--soundcloud);color:#fff;margin-left:6px}
    .empty_library{padding:28px 14px;color:var(--muted);text-align:center}
    .empty_hint{font-size:13px;color:var(--muted)}
    .drag_drop_area{border:1px dashed var(--border);padding:20px;text-align:center;background:var(--panel);color:var(--muted);margin-bottom:14px;cursor:pointer}
    .drag_drop_area:hover{background:var(--panel-2)}
    .drag_drop_area.drag_over{border-color:var(--accent)}
    .now_playing_container{display:none;margin-top:12px;padding:12px;background:var(--panel-2);border:1px solid var(--border)}
    .now_playing_container.visible{display:block}
    .now_playing_header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .now_playing_header h3{color:var(--accent);font-size:13px;margin:0}
    .header_buttons{display:flex;gap:6px}
    .visualizer_toggle,.settings_toggle{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 10px;font-size:11px;cursor:pointer;font-family:monospace}
    .visualizer_toggle:hover,.settings_toggle:hover{background:var(--bg)}
    .visualizer_toggle.active,.settings_toggle.active{border-color:var(--accent);color:var(--accent)}
    .settings_panel{display:none;margin-top:8px;padding:12px;background:var(--panel);border:1px solid var(--border)}
    .settings_panel.active{display:block}
    .settings_title{color:var(--accent);font-size:12px;font-weight:700;margin-bottom:10px}
    .setting_item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
    .setting_item:last-child{border-bottom:none}
    .setting_label{color:var(--text);font-size:12px}
    .setting_control{display:flex;gap:8px;align-items:center}
    .toggle_switch{width:40px;height:20px;background:var(--panel-2);border:1px solid var(--border);position:relative;cursor:pointer}
    .toggle_switch.active{border-color:var(--accent)}
    .toggle_switch_handle{width:16px;height:16px;background:var(--text);position:absolute;top:1px;left:1px;transition:left 0.15s}
    .toggle_switch.active .toggle_switch_handle{left:21px;background:var(--accent)}
    .crossfade_input{width:50px;background:var(--panel-2);border:1px solid var(--border);color:var(--text);padding:4px 6px;font-family:monospace;font-size:12px;text-align:center}
    .crossfade_input:focus{outline:none;border-color:var(--accent)}
    .now_playing_content{display:flex;gap:12px;align-items:center}
    .album_art_container{flex-shrink:0;position:relative;width:100px;height:100px}
    .main_image{width:100px;height:100px;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--accent);font-weight:700;overflow:hidden}
    .main_image img{width:100%;height:100%;object-fit:cover}
    .visualizer_canvas{position:absolute;top:0;left:0;width:100%;height:100%;border:1px solid var(--border);background:rgba(18,18,18,0.9);display:none}
    .visualizer_canvas.active{display:block}
    .track_info_panel{flex:1;min-width:0}
    .music_info{font-size:13px;color:var(--text);margin-bottom:10px}
    .song_title{color:var(--text);font-weight:700;font-size:14px;display:block;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .artist_name{color:var(--muted);font-size:12px;display:block;margin-bottom:2px}
    .album_name{color:var(--muted);font-size:11px;display:block}
    .progress_container{margin-top:10px}
    .progress_bar{width:100%;height:20px;background:var(--panel);border:1px solid var(--border);position:relative;cursor:pointer}
    .progress_fill{height:100%;width:0%;background:var(--accent);pointer-events:none}
    .progress_fill.sc{background:var(--soundcloud)}
    .progress_handle{position:absolute;top:50%;transform:translate(-50%,-50%);width:8px;height:16px;background:var(--text);border:1px solid var(--border);pointer-events:none}
    .time_display{display:flex;justify-content:space-between;color:var(--muted);font-size:11px;margin-top:6px}
    .music_controls{display:flex;align-items:center;gap:8px;margin-top:12px;flex-wrap:wrap}
    .music_btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-size:13px;cursor:pointer;font-family:monospace;font-weight:700}
    .music_btn:hover{background:var(--panel-2)}
    .music_btn.active{border-color:var(--accent);color:var(--accent)}
    .volume_control{margin-left:auto;display:flex;align-items:center;gap:8px}
    .volume_icon{color:var(--muted);font-size:13px}
    .volume_slider_container{position:relative;width:80px;height:20px;background:var(--panel);border:1px solid var(--border);cursor:pointer}
    .volume_slider_fill{height:100%;width:80%;background:var(--accent);pointer-events:none}
    .volume_slider_handle{position:absolute;top:50%;transform:translate(-50%,-50%);width:6px;height:14px;background:var(--text);border:1px solid var(--border);pointer-events:none}
    .status_message{margin-top:10px;padding:8px;font-size:12px;border:1px solid var(--border);color:var(--muted);background:var(--panel);text-align:center;display:none}
    .status_success{color:var(--success);border-color:var(--success)}
    .status_error{color:var(--error);border-color:var(--error)}
    .delete_btn{background:transparent;border:1px solid var(--border);color:var(--error);width:26px;height:26px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;font-family:monospace;flex-shrink:0}
    .track_item:hover .delete_btn{opacity:1}
    .footer{margin-top:14px;text-align:center;color:var(--muted);font-size:11px;opacity:0.9}
    .sc_widget_container{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden}
    .hidden{display:none!important}
    @media(max-width:768px){.now_playing_content{flex-direction:column;align-items:flex-start}.volume_control{margin-left:0;margin-top:8px}.album_art_container,.main_image{width:80px;height:80px}.track_art{width:36px;height:36px}.soundcloud_input_row{flex-direction:column}.music_controls{justify-content:center}}
  </style>
</head>
<body>
  <div class="animated_background">
    <div class="bg_blob blob1"></div>
    <div class="bg_blob blob2"></div>
    <div class="bg_blob blob3"></div>
  </div>
  <div class="container">
    <div class="center_box">
      <h1 class="app-title">eXey</h1>
      <p class="app-subtitle">Your personal music collection</p>
      <div class="search_container">
        <input type="text" class="search_input" id="searchInput" placeholder="Search tracks, artists, albums...">
      </div>
      <div class="soundcloud_container">
        <div class="soundcloud_header">
          <h3>SoundCloud Import</h3>
          <span class="soundcloud_badge">SC</span>
        </div>
        <div class="soundcloud_input_row">
          <input type="text" class="soundcloud_input" id="soundcloudInput" placeholder="Paste SoundCloud track URL...">
          <button class="soundcloud_btn" id="soundcloudImportBtn">IMPORT</button>
        </div>
        <div class="soundcloud_hint">Example: https://soundcloud.com/artist/track-name</div>
      </div>
      <div class="library_container">
        <div class="library_header">
          <h2>Library</h2>
          <div class="library_header_right">
            <div class="library_stats"><span id="trackCount">0 tracks</span></div>
            <button class="clear_library_btn" id="clearLibraryBtn">CLEAR ALL</button>
          </div>
        </div>
        <div class="track_list" id="trackList">
          <div class="empty_library">
            <p>No tracks in your library yet</p>
            <p class="empty_hint">Drag and drop audio files or import from SoundCloud</p>
          </div>
        </div>
      </div>
      <div class="drag_drop_area" id="dragDropArea">
        <div class="drag_drop_text">Drag and Drop Audio Files Here</div>
        <div class="drag_drop_hint">or click to browse your files</div>
      </div>
      <div class="now_playing_container" id="nowPlayingContainer">
        <div class="now_playing_header">
          <h3>Now Playing</h3>
          <div class="header_buttons">
            <button class="settings_toggle" id="settingsToggle">SETTINGS</button>
            <button class="visualizer_toggle" id="visualizerToggle">VISUALIZER</button>
          </div>
        </div>
        <div class="settings_panel" id="settingsPanel">
          <div class="settings_title">AUDIO SETTINGS</div>
          <div class="setting_item">
            <span class="setting_label">Crossfade</span>
            <div class="setting_control">
              <div class="toggle_switch" id="crossfadeToggle"><div class="toggle_switch_handle"></div></div>
            </div>
          </div>
          <div class="setting_item hidden" id="crossfadeDurationSetting">
            <span class="setting_label">Crossfade Duration (sec)</span>
            <div class="setting_control">
              <input type="number" class="crossfade_input" id="crossfadeDuration" value="3" min="1" max="10">
            </div>
          </div>
        </div>
        <div class="now_playing_content">
          <div class="album_art_container">
            <div class="main_image" id="albumArt">eXey</div>
            <canvas class="visualizer_canvas" id="visualizerCanvas" width="100" height="100"></canvas>
          </div>
          <div class="track_info_panel">
            <div class="music_info" id="musicInfo">
              <span class="song_title">No track selected</span>
              <span class="artist_name">Select a track to play</span>
              <span class="album_name">Your music library</span>
            </div>
            <div class="progress_container">
              <div class="progress_bar" id="progressBar">
                <div class="progress_fill" id="progressFill"></div>
                <div class="progress_handle" id="progressHandle"></div>
              </div>
              <div class="time_display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
              </div>
            </div>
            <div class="music_controls">
              <button class="music_btn" id="shuffleBtn" title="Shuffle">&#8652;</button>
              <button class="music_btn" id="prevBtn">&#9664;&#9664;</button>
              <button class="music_btn" id="playPauseBtn">&#9654;</button>
              <button class="music_btn" id="nextBtn">&#9654;&#9654;</button>
              <button class="music_btn" id="repeatBtn" title="Repeat">&#8635;</button>
              <div class="volume_control">
                <span class="volume_icon">VOL</span>
                <div class="volume_slider_container" id="volumeSlider">
                  <div class="volume_slider_fill" id="volumeFill"></div>
                  <div class="volume_slider_handle" id="volumeHandle"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="status_message" id="statusMessage"></div>
    </div>
    <div class="footer">eXey Player - Your personal music collection</div>
  </div>
  
  <div class="sc_widget_container" id="scWidgetContainer"></div>
  
  <audio id="audioPlayer" crossorigin="anonymous"></audio>
  <audio id="audioPlayerB" crossorigin="anonymous"></audio>
  
  <script src="https://w.soundcloud.com/player/api.js"></script>
  <script>
(function(){
  'use strict';
  
  const $ = id => document.getElementById(id);
  const DB_NAME = 'eXeyDB';
  const DB_VERSION = 2;
  
  const el = {
    searchInput: $('searchInput'),
    soundcloudInput: $('soundcloudInput'),
    soundcloudImportBtn: $('soundcloudImportBtn'),
    trackList: $('trackList'),
    trackCount: $('trackCount'),
    dragDropArea: $('dragDropArea'),
    nowPlayingContainer: $('nowPlayingContainer'),
    albumArt: $('albumArt'),
    musicInfo: $('musicInfo'),
    progressBar: $('progressBar'),
    progressFill: $('progressFill'),
    progressHandle: $('progressHandle'),
    currentTime: $('currentTime'),
    duration: $('duration'),
    playPauseBtn: $('playPauseBtn'),
    prevBtn: $('prevBtn'),
    nextBtn: $('nextBtn'),
    shuffleBtn: $('shuffleBtn'),
    repeatBtn: $('repeatBtn'),
    volumeSlider: $('volumeSlider'),
    volumeFill: $('volumeFill'),
    volumeHandle: $('volumeHandle'),
    visualizerToggle: $('visualizerToggle'),
    visualizerCanvas: $('visualizerCanvas'),
    settingsToggle: $('settingsToggle'),
    settingsPanel: $('settingsPanel'),
    crossfadeToggle: $('crossfadeToggle'),
    crossfadeDuration: $('crossfadeDuration'),
    crossfadeDurationSetting: $('crossfadeDurationSetting'),
    clearLibraryBtn: $('clearLibraryBtn'),
    statusMessage: $('statusMessage'),
    audioPlayer: $('audioPlayer'),
    audioPlayerB: $('audioPlayerB'),
    scWidgetContainer: $('scWidgetContainer')
  };
  
  const state = {
    library: [],
    filtered: [],
    currentIndex: -1,
    isPlaying: false,
    shuffle: false,
    repeat: 0,
    volume: 0.8,
    crossfade: false,
    crossfadeSec: 3,
    isCrossfading: false,
    durations: {},
    activePlayer: 'A',
    db: null,
    scWidget: null,
    scReady: false,
    scPlaying: false,
    scDuration: 0,
    scPosition: 0
  };
  
  let audioCtx = null;
  let analyser = null;
  let dataArray = null;
  let sourceA = null;
  let sourceB = null;
  let visualizerActive = false;
  let scVisualizerData = new Uint8Array(32);
  let scVisualizerTimer = null;
  const canvasCtx = el.visualizerCanvas.getContext('2d');
  const blobs = document.querySelectorAll('.bg_blob');
  
  function init() {
    initDB().then(() => {
      loadLibrary();
      setupEvents();
      updateVolume();
      requestAnimationFrame(animate);
    });
  }
  
  function initDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onerror = () => reject(req.error);
      req.onsuccess = () => { state.db = req.result; resolve(); };
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains('tracks')) {
          db.createObjectStore('tracks', { keyPath: 'id' });
        }
      };
    });
  }
  
  function loadLibrary() {
    const tx = state.db.transaction('tracks', 'readonly');
    tx.objectStore('tracks').getAll().onsuccess = e => {
      state.library = e.target.result || [];
      state.filtered = [...state.library];
      state.library.forEach(t => { if (!t.isSoundCloud && t.audioBlob) loadDuration(t); });
      renderLibrary();
      if (state.library.length) showStatus(`Loaded ${state.library.length} tracks`, 'success');
    };
  }
  
  function saveTrack(track) {
    return new Promise((res, rej) => {
      const tx = state.db.transaction('tracks', 'readwrite');
      const req = tx.objectStore('tracks').put(track);
      req.onsuccess = res;
      req.onerror = () => rej(req.error);
    });
  }
  
  function deleteTrackDB(id) {
    return new Promise((res, rej) => {
      const tx = state.db.transaction('tracks', 'readwrite');
      const req = tx.objectStore('tracks').delete(id);
      req.onsuccess = res;
      req.onerror = () => rej(req.error);
    });
  }
  
  function clearDB() {
    return new Promise((res, rej) => {
      const tx = state.db.transaction('tracks', 'readwrite');
      const req = tx.objectStore('tracks').clear();
      req.onsuccess = res;
      req.onerror = () => rej(req.error);
    });
  }
  
  function loadDuration(track) {
    if (state.durations[track.id] || !track.audioBlob) return;
    const url = URL.createObjectURL(track.audioBlob);
    const audio = new Audio();
    audio.src = url;
    audio.onloadedmetadata = () => {
      state.durations[track.id] = audio.duration;
      URL.revokeObjectURL(url);
      renderLibrary();
    };
    audio.onerror = () => URL.revokeObjectURL(url);
  }
  
  function setupEvents() {
    el.searchInput.addEventListener('input', debounce(filterTracks, 150));
    el.soundcloudImportBtn.addEventListener('click', importSC);
    el.soundcloudInput.addEventListener('keypress', e => { if (e.key === 'Enter') importSC(); });
    
    el.dragDropArea.addEventListener('click', () => {
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = 'audio/*'; inp.multiple = true;
      inp.onchange = e => processFiles(Array.from(e.target.files));
      inp.click();
    });
    el.dragDropArea.addEventListener('dragover', e => { e.preventDefault(); el.dragDropArea.classList.add('drag_over'); });
    el.dragDropArea.addEventListener('dragleave', () => el.dragDropArea.classList.remove('drag_over'));
    el.dragDropArea.addEventListener('drop', e => {
      e.preventDefault();
      el.dragDropArea.classList.remove('drag_over');
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('audio/'));
      if (files.length) processFiles(files);
      else showStatus('Please select audio files', 'error');
    });
    
    el.playPauseBtn.addEventListener('click', togglePlayPause);
    el.prevBtn.addEventListener('click', playPrev);
    el.nextBtn.addEventListener('click', playNext);
    el.shuffleBtn.addEventListener('click', toggleShuffle);
    el.repeatBtn.addEventListener('click', toggleRepeat);
    el.progressBar.addEventListener('mousedown', startSeek);
    el.volumeSlider.addEventListener('mousedown', startVolume);
    
    el.settingsToggle.addEventListener('click', () => {
      el.settingsPanel.classList.toggle('active');
      el.settingsToggle.classList.toggle('active');
    });
    el.crossfadeToggle.addEventListener('click', () => {
      state.crossfade = !state.crossfade;
      el.crossfadeToggle.classList.toggle('active', state.crossfade);
      el.crossfadeDurationSetting.classList.toggle('hidden', !state.crossfade);
      showStatus(state.crossfade ? 'Crossfade on' : 'Crossfade off', 'success');
    });
    el.crossfadeDuration.addEventListener('change', e => {
      state.crossfadeSec = Math.max(1, Math.min(10, parseInt(e.target.value) || 3));
      e.target.value = state.crossfadeSec;
    });
    
    el.visualizerToggle.addEventListener('click', toggleVisualizer);
    el.clearLibraryBtn.addEventListener('click', () => {
      if (state.library.length && confirm(`Clear all ${state.library.length} tracks?`)) clearLibrary();
    });
    
    el.audioPlayer.addEventListener('timeupdate', () => onTimeUpdate('A'));
    el.audioPlayer.addEventListener('ended', onTrackEnd);
    el.audioPlayer.addEventListener('loadedmetadata', () => onMeta('A'));
    el.audioPlayerB.addEventListener('timeupdate', () => onTimeUpdate('B'));
    el.audioPlayerB.addEventListener('ended', onTrackEnd);
    el.audioPlayerB.addEventListener('loadedmetadata', () => onMeta('B'));
  }
  
  function debounce(fn, ms) {
    let t;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
  }
  
  function filterTracks() {
    const q = el.searchInput.value.toLowerCase().trim();
    state.filtered = q ? state.library.filter(t =>
      t.metadata.title.toLowerCase().includes(q) ||
      t.metadata.artist.toLowerCase().includes(q) ||
      t.metadata.album.toLowerCase().includes(q)
    ) : [...state.library];
    renderLibrary();
  }
  
  async function importSC() {
    const url = el.soundcloudInput.value.trim();
    if (!url || !url.includes('soundcloud.com')) {
      showStatus('Enter a valid SoundCloud URL', 'error');
      return;
    }
    
    el.soundcloudImportBtn.disabled = true;
    el.soundcloudImportBtn.textContent = 'LOADING...';
    
    try {
      const res = await fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(url)}`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      
      if (state.library.some(t => t.isSoundCloud && t.soundCloudUrl === url)) {
        showStatus('Track already exists', 'error');
        return;
      }
      
      const track = {
        id: genId(),
        isSoundCloud: true,
        soundCloudUrl: url,
        timestamp: Date.now(),
        metadata: {
          title: data.title || 'Unknown',
          artist: data.author_name || 'Unknown',
          album: 'SoundCloud',
          albumArtUrl: data.thumbnail_url || null
        }
      };
      
      await saveTrack(track);
      state.library.push(track);
      state.filtered = [...state.library];
      renderLibrary();
      el.soundcloudInput.value = '';
      showStatus(`Added "${track.metadata.title}"`, 'success');
    } catch {
      showStatus('Error importing from SoundCloud', 'error');
    } finally {
      el.soundcloudImportBtn.disabled = false;
      el.soundcloudImportBtn.textContent = 'IMPORT';
    }
  }
  
  async function processFiles(files) {
    let added = 0;
    for (const file of files) {
      if (state.library.some(t => t.fileName === file.name && t.fileSize === file.size)) continue;
      try {
        const metadata = await extractMeta(file);
        const track = {
          id: genId(),
          isSoundCloud: false,
          fileName: file.name,
          fileSize: file.size,
          timestamp: Date.now(),
          metadata,
          audioBlob: new Blob([file], { type: file.type })
        };
        await saveTrack(track);
        state.library.push(track);
        loadDuration(track);
        added++;
      } catch {}
    }
    if (added) {
      state.filtered = [...state.library];
      renderLibrary();
      showStatus(`Added ${added} track(s)`, 'success');
      if (state.library.length === added) playTrack(0);
    }
  }
  
  function extractMeta(file) {
    return new Promise(res => {
      const fallback = { title: file.name.replace(/\.[^/.]+$/, ''), artist: 'Unknown', album: 'Unknown', albumArtUrl: null };
      if (!window.jsmediatags) { res(fallback); return; }
      window.jsmediatags.read(file, {
        onSuccess: tag => {
          const t = tag.tags || {};
          let art = null;
          if (t.picture) {
            const p = t.picture;
            art = `data:${p.format};base64,${btoa(String.fromCharCode(...new Uint8Array(p.data)))}`;
          }
          res({ title: t.title || fallback.title, artist: t.artist || fallback.artist, album: t.album || fallback.album, albumArtUrl: art });
        },
        onError: () => res(fallback)
      });
    });
  }
  
  function renderLibrary() {
    const list = state.filtered;
    el.trackCount.textContent = `${list.length} track${list.length !== 1 ? 's' : ''}`;
    
    if (!list.length) {
      el.trackList.innerHTML = `<div class="empty_library"><p>${el.searchInput.value ? 'No tracks found' : 'Library empty'}</p><p class="empty_hint">${el.searchInput.value ? 'Try different search' : 'Drag files or import from SoundCloud'}</p></div>`;
      if (!state.library.length) el.nowPlayingContainer.classList.remove('visible');
      return;
    }
    
    const frag = document.createDocumentFragment();
    list.forEach(track => {
      const idx = state.library.indexOf(track);
      const div = document.createElement('div');
      div.className = 'track_item' + (idx === state.currentIndex ? ' active' : '') + (track.isSoundCloud ? ' soundcloud_track' : '');
      
      const dur = track.isSoundCloud ? 'SC' : (state.durations[track.id] ? formatTime(state.durations[track.id]) : '--:--');
      const artClass = track.isSoundCloud ? 'track_art soundcloud_art' : 'track_art';
      const artContent = track.metadata.albumArtUrl ? `<img src="${track.metadata.albumArtUrl}">` : (track.isSoundCloud ? 'SC' : 'eX');
      
      div.innerHTML = `<div class="${artClass}">${artContent}</div><div class="track_info"><div class="track_title">${esc(track.metadata.title)}${track.isSoundCloud ? '<span class="track_source">SC</span>' : ''}</div><div class="track_artist">${esc(track.metadata.artist)}</div><div class="track_album">${esc(track.metadata.album)}</div></div><div class="track_duration">${dur}</div><button class="delete_btn">x</button>`;
      
      div.querySelector('.delete_btn').onclick = e => { e.stopPropagation(); removeTrack(idx); };
      div.onclick = () => playTrack(idx);
      frag.appendChild(div);
    });
    
    el.trackList.innerHTML = '';
    el.trackList.appendChild(frag);
    el.nowPlayingContainer.classList.add('visible');
  }
  
  async function removeTrack(idx) {
    const track = state.library[idx];
    if (!track) return;
    await deleteTrackDB(track.id);
    delete state.durations[track.id];
    state.library.splice(idx, 1);
    if (state.currentIndex === idx) { pause(); state.currentIndex = -1; resetNowPlaying(); }
    else if (state.currentIndex > idx) state.currentIndex--;
    state.filtered = [...state.library];
    filterTracks();
    showStatus('Track removed', 'success');
  }
  
  async function clearLibrary() {
    pause();
    destroySCWidget();
    await clearDB();
    state.library = [];
    state.filtered = [];
    state.currentIndex = -1;
    state.durations = {};
    resetNowPlaying();
    renderLibrary();
    showStatus('Library cleared', 'success');
  }
  
  function playTrack(idx) {
    if (idx < 0 || idx >= state.library.length) return;
    const track = state.library[idx];
    state.currentIndex = idx;
    state.isCrossfading = false;
    
    el.audioPlayer.pause();
    el.audioPlayerB.pause();
    el.audioPlayer.src = '';
    el.audioPlayerB.src = '';
    
    if (track.isSoundCloud) {
      playSC(track);
    } else {
      destroySCWidget();
      state.scPlaying = false;
      el.progressFill.classList.remove('sc');
      
      const player = state.activePlayer === 'A' ? el.audioPlayer : el.audioPlayerB;
      player.src = URL.createObjectURL(track.audioBlob);
      player.volume = state.volume;
      
      updateNowPlaying(track);
      renderLibrary();
      play();
    }
  }
  
  function playSC(track) {
    state.scPlaying = true;
    el.progressFill.classList.add('sc');
    updateNowPlaying(track);
    renderLibrary();
    
    createSCWidget(track.soundCloudUrl);
  }
  
  function createSCWidget(url) {
    destroySCWidget();
    
    const iframe = document.createElement('iframe');
    iframe.id = 'scWidget';
    iframe.width = '100%';
    iframe.height = '166';
    iframe.scrolling = 'no';
    iframe.frameBorder = 'no';
    iframe.allow = 'autoplay';
    iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=true&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=false`;
    
    el.scWidgetContainer.innerHTML = '';
    el.scWidgetContainer.appendChild(iframe);
    
    state.scWidget = SC.Widget(iframe);
    state.scReady = false;
    
    state.scWidget.bind(SC.Widget.Events.READY, () => {
      state.scReady = true;
      state.scWidget.setVolume(state.volume * 100);
      state.scWidget.play();
      
      state.scWidget.getDuration(d => {
        state.scDuration = d / 1000;
        el.duration.textContent = formatTime(state.scDuration);
      });
    });
    
    state.scWidget.bind(SC.Widget.Events.PLAY, () => {
      state.isPlaying = true;
      updatePlayBtn();
      startSCVisualizer();
    });
    
    state.scWidget.bind(SC.Widget.Events.PAUSE, () => {
      state.isPlaying = false;
      updatePlayBtn();
      stopSCVisualizer();
    });
    
    state.scWidget.bind(SC.Widget.Events.FINISH, () => {
      state.isPlaying = false;
      updatePlayBtn();
      stopSCVisualizer();
      onTrackEnd();
    });
    
    state.scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, e => {
      state.scPosition = e.currentPosition / 1000;
      const pct = state.scDuration ? (state.scPosition / state.scDuration) * 100 : 0;
      el.progressFill.style.width = pct + '%';
      el.progressHandle.style.left = pct + '%';
      el.currentTime.textContent = formatTime(state.scPosition);
    });
  }
  
  function destroySCWidget() {
    stopSCVisualizer();
    if (state.scWidget) {
      try { state.scWidget.unbind(SC.Widget.Events.READY); } catch {}
      try { state.scWidget.unbind(SC.Widget.Events.PLAY); } catch {}
      try { state.scWidget.unbind(SC.Widget.Events.PAUSE); } catch {}
      try { state.scWidget.unbind(SC.Widget.Events.FINISH); } catch {}
      try { state.scWidget.unbind(SC.Widget.Events.PLAY_PROGRESS); } catch {}
    }
    state.scWidget = null;
    state.scReady = false;
    el.scWidgetContainer.innerHTML = '';
  }
  
  function startSCVisualizer() {
    if (scVisualizerTimer) return;
    scVisualizerTimer = setInterval(() => {
      for (let i = 0; i < scVisualizerData.length; i++) {
        const target = state.isPlaying ? 50 + Math.random() * 150 : 0;
        scVisualizerData[i] += (target - scVisualizerData[i]) * 0.3;
      }
    }, 50);
  }
  
  function stopSCVisualizer() {
    if (scVisualizerTimer) {
      clearInterval(scVisualizerTimer);
      scVisualizerTimer = null;
    }
  }
  
  function play() {
    if (state.scPlaying && state.scWidget && state.scReady) {
      state.scWidget.play();
      return;
    }
    
    const player = state.activePlayer === 'A' ? el.audioPlayer : el.audioPlayerB;
    player.play().then(() => {
      state.isPlaying = true;
      updatePlayBtn();
      initAudioCtx();
    }).catch(() => showStatus('Error playing', 'error'));
  }
  
  function pause() {
    if (state.scPlaying && state.scWidget && state.scReady) {
      state.scWidget.pause();
    }
    el.audioPlayer.pause();
    el.audioPlayerB.pause();
    state.isPlaying = false;
    updatePlayBtn();
  }
  
  function togglePlayPause() {
    if (state.currentIndex === -1 && state.library.length) playTrack(0);
    else if (state.isPlaying) pause();
    else play();
  }
  
  function updatePlayBtn() {
    el.playPauseBtn.innerHTML = state.isPlaying ? '&#10074;&#10074;' : '&#9654;';
  }
  
  function playNext() {
    if (!state.library.length) return;
    const next = getNextIdx();
    if (next === -1) pause();
    else playTrack(next);
  }
  
  function playPrev() {
    if (!state.library.length) return;
    let idx = state.currentIndex - 1;
    if (idx < 0) idx = state.library.length - 1;
    playTrack(idx);
  }
  
  function getNextIdx() {
    if (!state.library.length) return -1;
    if (state.repeat === 2) return state.currentIndex;
    if (state.shuffle) {
      if (state.library.length === 1) return 0;
      let idx;
      do { idx = Math.floor(Math.random() * state.library.length); } while (idx === state.currentIndex);
      return idx;
    }
    const next = state.currentIndex + 1;
    return next >= state.library.length ? (state.repeat === 1 ? 0 : -1) : next;
  }
  
  function toggleShuffle() {
    state.shuffle = !state.shuffle;
    el.shuffleBtn.classList.toggle('active', state.shuffle);
    showStatus(state.shuffle ? 'Shuffle on' : 'Shuffle off', 'success');
  }
  
  function toggleRepeat() {
    state.repeat = (state.repeat + 1) % 3;
    el.repeatBtn.classList.toggle('active', state.repeat > 0);
    el.repeatBtn.innerHTML = state.repeat === 2 ? '&#8635;1' : '&#8635;';
    showStatus(['Repeat off', 'Repeat all', 'Repeat one'][state.repeat], 'success');
  }
  
  function onTimeUpdate(which) {
    if (state.scPlaying) return;
    if (state.activePlayer !== which) return;
    const player = which === 'A' ? el.audioPlayer : el.audioPlayerB;
    updateProgress(player);
    checkCrossfade(player);
  }
  
  function updateProgress(player) {
    if (!player.duration) return;
    const pct = (player.currentTime / player.duration) * 100;
    el.progressFill.style.width = pct + '%';
    el.progressHandle.style.left = pct + '%';
    el.currentTime.textContent = formatTime(player.currentTime);
  }
  
  function onMeta(which) {
    if (state.scPlaying) return;
    if (state.activePlayer !== which) return;
    const player = which === 'A' ? el.audioPlayer : el.audioPlayerB;
    el.duration.textContent = formatTime(player.duration);
  }
  
  function onTrackEnd() {
    if (state.isCrossfading) return;
    if (state.repeat === 2) {
      if (state.scPlaying && state.scWidget && state.scReady) {
        state.scWidget.seekTo(0);
        state.scWidget.play();
      } else {
        const player = state.activePlayer === 'A' ? el.audioPlayer : el.audioPlayerB;
        player.currentTime = 0;
        play();
      }
    } else {
      playNext();
    }
  }
  
  function checkCrossfade(player) {
    if (!state.crossfade || state.isCrossfading || state.repeat === 2 || state.scPlaying) return;
    if (!player.duration) return;
    const left = player.duration - player.currentTime;
    if (left <= state.crossfadeSec && left > 0) {
      const next = getNextIdx();
      if (next !== -1 && next !== state.currentIndex && !state.library[next].isSoundCloud) {
        startCrossfade(next);
      }
    }
  }
  
  function startCrossfade(nextIdx) {
    state.isCrossfading = true;
    const curr = state.activePlayer === 'A' ? el.audioPlayer : el.audioPlayerB;
    const next = state.activePlayer === 'A' ? el.audioPlayerB : el.audioPlayer;
    const track = state.library[nextIdx];
    
    next.src = URL.createObjectURL(track.audioBlob);
    next.volume = 0;
    
    next.play().then(() => {
      const steps = state.crossfadeSec * 20;
      let step = 0;
      const iv = setInterval(() => {
        step++;
        curr.volume = state.volume * (1 - step / steps);
        next.volume = state.volume * (step / steps);
        if (step >= steps) {
          clearInterval(iv);
          curr.pause();
          curr.src = '';
          state.activePlayer = state.activePlayer === 'A' ? 'B' : 'A';
          state.currentIndex = nextIdx;
          state.isCrossfading = false;
          updateNowPlaying(track);
          renderLibrary();
          connectSource();
        }
      }, 50);
    }).catch(() => { state.isCrossfading = false; });
  }
  
  function startSeek(e) {
    seek(e);
    const move = e => seek(e);
    const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  }
  
  function seek(e) {
    const rect = el.progressBar.getBoundingClientRect();
    const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    
    if (state.scPlaying && state.scWidget && state.scReady) {
      state.scWidget.seekTo(pct * state.scDuration * 1000);
    } else {
      const player = state.activePlayer === 'A' ? el.audioPlayer : el.audioPlayerB;
      if (player.duration) player.currentTime = pct * player.duration;
    }
  }
  
  function startVolume(e) {
    setVol(e);
    const move = e => setVol(e);
    const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  }
  
  function setVol(e) {
    const rect = el.volumeSlider.getBoundingClientRect();
    state.volume = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
    el.audioPlayer.volume = state.volume;
    el.audioPlayerB.volume = state.volume;
    if (state.scWidget && state.scReady) state.scWidget.setVolume(state.volume * 100);
    updateVolume();
  }
  
  function updateVolume() {
    const pct = state.volume * 100;
    el.volumeFill.style.width = pct + '%';
    el.volumeHandle.style.left = pct + '%';
  }
  
  function toggleVisualizer() {
    visualizerActive = !visualizerActive;
    el.visualizerToggle.classList.toggle('active', visualizerActive);
    el.visualizerCanvas.classList.toggle('active', visualizerActive);
    if (visualizerActive && !state.scPlaying) initAudioCtx();
  }
  
  function initAudioCtx() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 64;
    analyser.smoothingTimeConstant = 0.8;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    connectSource();
    analyser.connect(audioCtx.destination);
  }
  
  function connectSource() {
    if (!audioCtx) return;
    try {
      if (state.activePlayer === 'A') {
        if (!sourceA) sourceA = audioCtx.createMediaElementSource(el.audioPlayer);
        sourceA.disconnect();
        sourceA.connect(analyser);
      } else {
        if (!sourceB) sourceB = audioCtx.createMediaElementSource(el.audioPlayerB);
        sourceB.disconnect();
        sourceB.connect(analyser);
      }
    } catch {}
  }
  
  function animate() {
    requestAnimationFrame(animate);
    
    let freqData;
    if (state.scPlaying) {
      freqData = scVisualizerData;
    } else if (analyser && state.isPlaying) {
      analyser.getByteFrequencyData(dataArray);
      freqData = dataArray;
    }
    
    if (freqData && state.isPlaying) {
      let sum = 0;
      for (let i = 0; i < freqData.length; i++) sum += freqData[i];
      const avg = sum / freqData.length / 255;
      
      blobs.forEach((blob, i) => {
        const scale = 1 + avg * 0.5;
        const opacity = 0.15 + avg * 0.15;
        const f = freqData[Math.min(i * 5, freqData.length - 1)] / 255;
        let transform;
        if (i === 0) transform = `translate(${f * 30}px, ${avg * 20}px) scale(${scale})`;
        else if (i === 1) transform = `translate(${-f * 25}px, ${-avg * 30}px) scale(${scale})`;
        else transform = `translate(-50%, -50%) scale(${scale}) rotate(${avg * 20}deg)`;
        blob.style.transform = transform;
        blob.style.opacity = opacity;
      });
    }
    
    if (!visualizerActive) return;
    
    const w = el.visualizerCanvas.width;
    const h = el.visualizerCanvas.height;
    canvasCtx.fillStyle = 'rgba(18,18,18,0.9)';
    canvasCtx.fillRect(0, 0, w, h);
    
    if (!freqData) return;
    
    const barW = w / freqData.length;
    for (let i = 0; i < freqData.length; i++) {
      const barH = (freqData[i] / 255) * h;
      const hue = state.scPlaying ? 20 : (i / freqData.length) * 60 + 180;
      const sat = state.scPlaying ? 100 : 30;
      canvasCtx.fillStyle = `hsl(${hue}, ${sat}%, 60%)`;
      canvasCtx.fillRect(i * barW, h - barH, barW - 1, barH);
    }
  }
  
  function updateNowPlaying(track) {
    el.musicInfo.innerHTML = `<span class="song_title">${esc(track.metadata.title)}</span><span class="artist_name">${esc(track.metadata.artist)}</span><span class="album_name">${esc(track.metadata.album)}</span>`;
    el.albumArt.innerHTML = track.metadata.albumArtUrl ? `<img src="${track.metadata.albumArtUrl}">` : (track.isSoundCloud ? 'SC' : 'eXey');
    el.nowPlayingContainer.classList.add('visible');
  }
  
  function resetNowPlaying() {
    el.musicInfo.innerHTML = '<span class="song_title">No track selected</span><span class="artist_name">Select a track</span><span class="album_name">Your library</span>';
    el.albumArt.innerHTML = 'eXey';
    el.progressFill.style.width = '0%';
    el.progressHandle.style.left = '0%';
    el.currentTime.textContent = '0:00';
    el.duration.textContent = '0:00';
    el.progressFill.classList.remove('sc');
    updatePlayBtn();
  }
  
  function formatTime(s) {
    if (!s || isNaN(s)) return '0:00';
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m}:${sec < 10 ? '0' : ''}${sec}`;
  }
  
  function genId() {
    return '_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
  }
  
  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }
  
  function showStatus(msg, type) {
    el.statusMessage.textContent = msg;
    el.statusMessage.className = `status_message status_${type}`;
    el.statusMessage.style.display = 'block';
    if (type === 'success') setTimeout(() => { el.statusMessage.style.display = 'none'; }, 3000);
  }
  
  init();
})();
  </script>
</body>
</html>
