<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  
  <!-- PWA Support -->
  <meta name="theme-color" content="#0b0b0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Music Player">
  
  <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ (base64) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéµ</text></svg>">
  
  <style>
    :root{
      --bg: #0b0b0b;
      --panel: #121212;
      --panel-2: #151515;
      --accent: #9ea3a8;
      --text: #d7d7d7;
      --muted: #909396;
      --success: #7fbf7f;
      --error: #d46b6b;
      --border: #262626;
      --spotify: #1db954;
      --soundcloud: #ff5500;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:16px;
      line-height:1.25;
      position:relative;
    }

    .animated_background{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      z-index:0;
      pointer-events:none;
    }

    .bg_blob{
      position:absolute;
      border-radius:50%;
      filter:blur(80px);
      opacity:0.15;
      transition:all 0.3s ease;
    }

    .blob1{
      width:300px;
      height:300px;
      background:radial-gradient(circle, #9ea3a8 0%, transparent 70%);
      top:20%;
      left:10%;
    }

    .blob2{
      width:400px;
      height:400px;
      background:radial-gradient(circle, #7fbf7f 0%, transparent 70%);
      bottom:10%;
      right:15%;
    }

    .blob3{
      width:350px;
      height:350px;
      background:radial-gradient(circle, #909396 0%, transparent 70%);
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
    }

    .container{width:100%;max-width:900px;position:relative;z-index:1;max-height:calc(100vh - 32px);overflow-y:auto}
    .center_box{
      background:rgba(18, 18, 18, 0.85);
      backdrop-filter:blur(10px);
      border:1px solid var(--border);
      border-radius:0;
      padding:20px;
      box-shadow:none;
      position:relative;
    }

    .app-title{
      color:var(--accent);
      font-weight:700;
      font-size:20px;
      letter-spacing:0.6px;
      margin-bottom:6px;
      text-transform:uppercase;
    }
    .app-subtitle{
      color:var(--muted);
      font-size:12px;
      margin-bottom:18px;
    }

    .install_prompt{
      background:linear-gradient(135deg, var(--accent), var(--success));
      color:var(--bg);
      padding:12px 16px;
      margin-bottom:14px;
      border-radius:4px;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .install_prompt.show{display:flex}

    .install_text{
      flex:1;
      font-size:12px;
      font-weight:600;
    }

    .install_btn{
      background:var(--bg);
      color:var(--accent);
      border:none;
      padding:8px 16px;
      font-size:11px;
      font-weight:700;
      cursor:pointer;
      font-family:monospace;
      white-space:nowrap;
    }

    .install_btn:hover{opacity:0.9}

    .close_install{
      background:transparent;
      color:var(--bg);
      border:none;
      cursor:pointer;
      font-size:18px;
      padding:0 4px;
    }

    .url_input_section{
      margin-bottom:14px;
      background:var(--panel-2);
      border:1px solid var(--border);
      padding:12px;
      border-radius:0;
    }

    .url_input_header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      flex-wrap:wrap;
      gap:8px;
    }

    .url_input_title{
      color:var(--accent);
      font-size:13px;
      font-weight:700;
    }

    .supported_platforms{
      display:flex;
      gap:6px;
      font-size:11px;
      flex-wrap:wrap;
    }

    .platform_badge{
      padding:3px 6px;
      border-radius:2px;
      font-weight:600;
    }

    .platform_soundcloud{
      background:rgba(255, 85, 0, 0.2);
      color:var(--soundcloud);
      border:1px solid var(--soundcloud);
    }

    .platform_direct{
      background:rgba(158, 163, 168, 0.2);
      color:var(--accent);
      border:1px solid var(--accent);
    }

    .url_input_container{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }

    .url_input{
      flex:1;
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      font-family:monospace;
      font-size:13px;
      border-radius:0;
    }

    .url_input:focus{
      outline:none;
      border-color:var(--accent);
    }

    .url_input::placeholder{
      color:var(--muted);
    }

    .add_url_btn{
      background:var(--panel);
      border:1px solid var(--accent);
      color:var(--accent);
      padding:10px 20px;
      font-size:12px;
      cursor:pointer;
      border-radius:0;
      font-family:monospace;
      font-weight:700;
      transition:all 0.2s;
    }

    .add_url_btn:hover{
      background:var(--accent);
      color:var(--bg);
    }

    .add_url_btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }

    .url_hint{
      color:var(--muted);
      font-size:11px;
      line-height:1.4;
    }

    .search_container{
      margin-bottom:14px;
    }
    .search_input{
      width:100%;
      background:var(--panel-2);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      font-family:monospace;
      font-size:13px;
      border-radius:0;
    }
    .search_input:focus{
      outline:none;
      border-color:var(--accent);
    }
    .search_input::placeholder{
      color:var(--muted);
    }

    .library_container{
      margin-bottom:18px;
      background:var(--panel-2);
      border:1px solid var(--border);
      padding:8px;
      border-radius:0;
    }

    .library_header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 8px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
      gap:8px;
    }

    .library_header h2{
      color:var(--accent);
      font-size:14px;
      font-weight:700;
      margin:0;
    }

    .library_header_right{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .library_stats{
      color:var(--muted);
      font-size:12px;
      background:transparent;
      padding:4px 8px;
      border-radius:0;
      border:1px solid var(--border);
    }

    .clear_library_btn{
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--error);
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      border-radius:0;
      font-family:monospace;
    }
    .clear_library_btn:hover{background:var(--bg)}

    .track_list{
      max-height:320px;
      overflow-y:auto;
      background:var(--panel);
      border:1px solid var(--border);
      margin-top:8px;
      border-radius:0;
    }

    .track_item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      background:transparent;
      transition:none;
    }

    .track_item:last-child{border-bottom:none}
    .track_item:hover{background:var(--panel-2)}
    .track_item.active{
      background:var(--panel-2);
      border-left:3px solid var(--accent);
    }

    .track_art{
      width:44px;
      height:44px;
      background:var(--panel-2);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      color:var(--accent);
      flex-shrink:0;
      position:relative;
    }

    .track_art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .track_source_badge{
      position:absolute;
      bottom:2px;
      right:2px;
      font-size:8px;
      padding:2px 3px;
      border-radius:2px;
      font-weight:700;
      background:rgba(0,0,0,0.7);
    }

    .track_info{flex:1;min-width:0}
    .track_title{
      color:var(--text);
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .track_artist{color:var(--muted);font-size:12px;display:block}
    .track_album{color:var(--muted);font-size:11px}
    .track_duration{color:var(--muted);font-size:12px;flex-shrink:0;margin-left:10px;min-width:40px;text-align:right}

    .empty_library{padding:28px 14px;color:var(--muted);text-align:center}
    .empty_hint{font-size:13px;color:var(--muted);margin-top:4px}

    .drag_drop_area{
      border:1px dashed var(--border);
      padding:20px;
      text-align:center;
      background:var(--panel);
      color:var(--muted);
      border-radius:0;
      margin-bottom:14px;
      cursor:pointer;
    }
    .drag_drop_area:hover{background:var(--panel-2)}
    .drag_drop_area.drag_over{border-color:var(--accent)}

    .now_playing_container{
      display:block;
      margin-top:12px;
      padding:12px;
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:0;
    }

    .now_playing_header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .now_playing_header h3{
      color:var(--accent);
      font-size:13px;
      margin:0;
    }

    .header_buttons{
      display:flex;
      gap:6px;
    }

    .visualizer_toggle, .settings_toggle{
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text);
      padding:6px 10px;
      font-size:11px;
      cursor:pointer;
      border-radius:0;
      font-family:monospace;
    }
    .visualizer_toggle:hover, .settings_toggle:hover{background:var(--bg)}
    .visualizer_toggle.active{border-color:var(--accent);color:var(--accent)}

    .settings_panel{
      display:none;
      margin-top:8px;
      padding:12px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:0;
    }
    .settings_panel.active{display:block}

    .settings_title{
      color:var(--accent);
      font-size:12px;
      font-weight:700;
      margin-bottom:10px;
    }

    .setting_item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid var(--border);
    }
    .setting_item:last-child{border-bottom:none}

    .setting_label{
      color:var(--text);
      font-size:12px;
    }

    .setting_control{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .toggle_switch{
      width:40px;
      height:20px;
      background:var(--panel-2);
      border:1px solid var(--border);
      position:relative;
      cursor:pointer;
      border-radius:0;
    }

    .toggle_switch.active{border-color:var(--accent)}

    .toggle_switch_handle{
      width:16px;
      height:16px;
      background:var(--text);
      position:absolute;
      top:1px;
      left:1px;
      transition:left 0.2s;
    }

    .toggle_switch.active .toggle_switch_handle{
      left:21px;
      background:var(--accent);
    }

    .crossfade_input{
      width:50px;
      background:var(--panel-2);
      border:1px solid var(--border);
      color:var(--text);
      padding:4px 6px;
      font-family:monospace;
      font-size:12px;
      border-radius:0;
      text-align:center;
    }
    .crossfade_input:focus{outline:none;border-color:var(--accent)}

    .now_playing_content{
      display:flex;
      gap:12px;
      align-items:center;
    }

    .album_art_container{flex-shrink:0;position:relative}

    .main_image{
      width:100px;
      height:100px;
      background:var(--panel);
      border:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      color:var(--accent);
    }

    .visualizer_canvas{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      border:1px solid var(--border);
      background:var(--panel);
      display:none;
    }
    .visualizer_canvas.active{display:block}

    .track_info_panel{flex:1}

    .music_info{font-size:13px;color:var(--text);margin-bottom:10px}
    .song_title{color:var(--text);font-weight:700;font-size:14px;display:block;margin-bottom:4px}
    .artist_name{color:var(--muted);font-size:12px;display:block;margin-bottom:2px}
    .album_name{color:var(--muted);font-size:11px;display:block}

    .progress_container{margin-top:10px;display:block}
    .progress_bar{
      width:100%;
      height:20px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:0;
      position:relative;
      cursor:pointer;
    }
    .progress_fill{
      height:100%;
      width:0%;
      background:var(--accent);
      transition:none;
      pointer-events:none;
    }
    .progress_handle{
      position:absolute;
      top:50%;
      transform:translate(-50%, -50%);
      width:8px;
      height:16px;
      background:var(--text);
      border:1px solid var(--border);
      pointer-events:none;
    }

    .time_display{
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:11px;
      margin-top:6px;
    }

    .music_controls{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
    }

    .music_btn{
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 12px;
      font-size:13px;
      cursor:pointer;
      border-radius:0;
      transition:none;
      font-family:monospace;
    }

    .music_btn:hover{background:var(--panel-2)}
    .music_btn.active{border-color:var(--accent);color:var(--accent)}

    .control_play,.control_pause{font-weight:700}
    .control_prev,.control_next{font-weight:600}

    .volume_control{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .volume_icon{color:var(--muted);font-size:13px}
    
    .volume_slider_container{
      position:relative;
      width:80px;
      height:20px;
      background:var(--panel);
      border:1px solid var(--border);
      cursor:pointer;
    }
    .volume_slider_fill{
      height:100%;
      width:80%;
      background:var(--accent);
      pointer-events:none;
    }
    .volume_slider_handle{
      position:absolute;
      top:50%;
      transform:translate(-50%, -50%);
      width:6px;
      height:14px;
      background:var(--text);
      border:1px solid var(--border);
      pointer-events:none;
    }

    .status_message{
      margin-top:10px;
      padding:8px;
      font-size:12px;
      border:1px solid var(--border);
      color:var(--muted);
      background:var(--panel);
      text-align:center;
      display:none;
    }
    .status_success{color:var(--success);border-color:var(--success)}
    .status_error{color:var(--error);border-color:var(--error)}

    .delete_btn{
      background:transparent;
      border:1px solid var(--border);
      color:var(--error);
      width:26px;height:26px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;border-radius:0;opacity:0;
      font-family:monospace;
    }
    .track_item:hover .delete_btn{opacity:1}

    .footer{margin-top:14px;text-align:center;color:var(--muted);font-size:11px;opacity:0.9}

    .loading_spinner{
      display:inline-block;
      width:14px;
      height:14px;
      border:2px solid var(--border);
      border-top:2px solid var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }

    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    @media (max-width:768px){
      .now_playing_content{flex-direction:column;align-items:flex-start}
      .volume_control{margin-left:0}
      .main_image{width:80px;height:80px}
      .track_art{width:36px;height:36px}
      .url_input_container{flex-direction:column}
      .add_url_btn{width:100%}
    }
  </style>
</head>
<body>
  <div class="animated_background">
    <div class="bg_blob blob1"></div>
    <div class="bg_blob blob2"></div>
    <div class="bg_blob blob3"></div>
  </div>

  <div class="container">
    <div class="center_box">
      <h1 class="app-title">üéµ Music Player</h1>
      <p class="app-subtitle">–¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä</p>
      
      <!-- PWA Install Prompt -->
      <div class="install_prompt" id="installPrompt">
        <div class="install_text">
          üì± –£—Å—Ç–∞–Ω–æ–≤–∏ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!
        </div>
        <button class="install_btn" id="installBtn">–£–°–¢–ê–ù–û–í–ò–¢–¨</button>
        <button class="close_install" id="closeInstall">√ó</button>
      </div>
      
      <div class="url_input_section">
        <div class="url_input_header">
          <span class="url_input_title">–î–û–ë–ê–í–ò–¢–¨ –¢–†–ï–ö –ü–û –°–°–´–õ–ö–ï</span>
          <div class="supported_platforms">
            <span class="platform_badge platform_soundcloud">SC</span>
            <span class="platform_badge platform_direct">URL</span>
          </div>
        </div>
        <div class="url_input_container">
          <input 
            type="text" 
            class="url_input" 
            id="urlInput" 
            placeholder="–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ MP3 —Ñ–∞–π–ª –∏–ª–∏ SoundCloud —Ç—Ä–µ–∫..."
          >
          <button class="add_url_btn" id="addUrlBtn">–î–û–ë–ê–í–ò–¢–¨</button>
        </div>
        <div class="url_hint">
          üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: SoundCloud —Ç—Ä–µ–∫–∏, –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ .mp3, .wav, .ogg —Ñ–∞–π–ª—ã
        </div>
      </div>

      <div class="search_container">
        <input type="text" class="search_input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, –∞–ª—å–±–æ–º–æ–≤...">
      </div>

      <div class="library_container">
        <div class="library_header">
          <h2>–ú–æ—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2>
          <div class="library_header_right">
            <div class="library_stats">
              <span id="trackCount">0 —Ç—Ä–µ–∫–æ–≤</span>
            </div>
            <button class="clear_library_btn" id="clearLibraryBtn">–û–ß–ò–°–¢–ò–¢–¨</button>
          </div>
        </div>
        
        <div class="track_list" id="trackList">
          <div class="empty_library">
            <p>–¢–≤–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞</p>
            <p class="empty_hint">–î–æ–±–∞–≤—å —Ç—Ä–µ–∫–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª—ã</p>
          </div>
        </div>
      </div>
      
      <div class="drag_drop_area" id="dragDropArea">
        <div class="drag_drop_text">üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏ –ê—É–¥–∏–æ –§–∞–π–ª—ã –°—é–¥–∞</div>
        <div class="drag_drop_hint">–∏–ª–∏ –Ω–∞–∂–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</div>
      </div>
      
      <div class="now_playing_container">
        <div class="now_playing_header">
          <h3>–°–µ–π—á–∞—Å –ò–≥—Ä–∞–µ—Ç</h3>
          <div class="header_buttons">
            <button class="settings_toggle" id="settingsToggle">–ù–ê–°–¢–†–û–ô–ö–ò</button>
            <button class="visualizer_toggle" id="visualizerToggle">–í–ò–ó–£–ê–õ–ò–ó–ê–¢–û–†</button>
          </div>
        </div>

        <div class="settings_panel" id="settingsPanel">
          <div class="settings_title">–ê–£–î–ò–û –ù–ê–°–¢–†–û–ô–ö–ò</div>
          <div class="setting_item">
            <span class="setting_label">–ö—Ä–æ—Å—Å-—Ñ–µ–π–¥</span>
            <div class="setting_control">
              <div class="toggle_switch" id="crossfadeToggle">
                <div class="toggle_switch_handle"></div>
              </div>
            </div>
          </div>
          <div class="setting_item" id="crossfadeDurationSetting" style="display:none">
            <span class="setting_label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫)</span>
            <div class="setting_control">
              <input type="number" class="crossfade_input" id="crossfadeDuration" value="3" min="1" max="10" step="1">
            </div>
          </div>
        </div>
        
        <div class="now_playing_content">
          <div class="album_art_container">
            <div class="main_image default-art" id="albumArt">‚ô´</div>
            <canvas class="visualizer_canvas" id="visualizerCanvas" width="100" height="100"></canvas>
          </div>
          
          <div class="track_info_panel">
            <div class="music_info" id="musicInfo">
              <span class="song_title">–¢—Ä–µ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
              <span class="artist_name">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è</span>
              <span class="album_name">–¢–≤–æ—è –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
            </div>
            
            <div class="progress_container" id="progressContainer">
              <div class="progress_bar" id="progressBar">
                <div class="progress_fill" id="progressFill"></div>
                <div class="progress_handle" id="progressHandle"></div>
              </div>
              <div class="time_display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
              </div>
            </div>
            
            <div class="music_controls">
              <button class="music_btn" id="shuffleBtn" title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫">
                <span>‚§Æ</span>
              </button>
              <button class="music_btn control_prev" id="prevBtn">
                <span>‚óÄ‚óÄ</span>
              </button>
              <button class="music_btn control_play" id="playBtn">
                <span>‚ñ∂</span>
              </button>
              <button class="music_btn control_pause" id="pauseBtn" style="display: none;">
                <span>‚ùö‚ùö</span>
              </button>
              <button class="music_btn control_next" id="nextBtn">
                <span>‚ñ∂‚ñ∂</span>
              </button>
              <button class="music_btn" id="repeatBtn" title="–ü–æ–≤—Ç–æ—Ä">
                <span>‚ü≤</span>
              </button>
              
              <div class="volume_control">
                <span class="volume_icon">üîä</span>
                <div class="volume_slider_container" id="volumeSliderContainer">
                  <div class="volume_slider_fill" id="volumeSliderFill"></div>
                  <div class="volume_slider_handle" id="volumeSliderHandle"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="status_message" id="statusMessage"></div>
    </div>
    
    <div class="footer">
      Music Player ‚Ä¢ –°–¥–µ–ª–∞–Ω–æ —Å ‚ù§Ô∏è
    </div>
  </div>
  
  <audio id="audioPlayer" crossorigin="anonymous"></audio>
  <audio id="nextAudioPlayer" crossorigin="anonymous"></audio>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dragDropArea = document.getElementById('dragDropArea');
      const albumArt = document.getElementById('albumArt');
      const musicInfo = document.getElementById('musicInfo');
      const audioPlayer = document.getElementById('audioPlayer');
      const nextAudioPlayer = document.getElementById('nextAudioPlayer');
      const playBtn = document.getElementById('playBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const shuffleBtn = document.getElementById('shuffleBtn');
      const repeatBtn = document.getElementById('repeatBtn');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressHandle = document.getElementById('progressHandle');
      const currentTimeEl = document.getElementById('currentTime');
      const durationEl = document.getElementById('duration');
      const statusMessage = document.getElementById('statusMessage');
      const trackList = document.getElementById('trackList');
      const trackCount = document.getElementById('trackCount');
      const searchInput = document.getElementById('searchInput');
      const volumeSliderContainer = document.getElementById('volumeSliderContainer');
      const volumeSliderFill = document.getElementById('volumeSliderFill');
      const volumeSliderHandle = document.getElementById('volumeSliderHandle');
      const visualizerToggle = document.getElementById('visualizerToggle');
      const visualizerCanvas = document.getElementById('visualizerCanvas');
      const settingsToggle = document.getElementById('settingsToggle');
      const settingsPanel = document.getElementById('settingsPanel');
      const crossfadeToggle = document.getElementById('crossfadeToggle');
      const crossfadeDuration = document.getElementById('crossfadeDuration');
      const crossfadeDurationSetting = document.getElementById('crossfadeDurationSetting');
      const clearLibraryBtn = document.getElementById('clearLibraryBtn');
      const urlInput = document.getElementById('urlInput');
      const addUrlBtn = document.getElementById('addUrlBtn');
      const installPrompt = document.getElementById('installPrompt');
      const installBtn = document.getElementById('installBtn');
      const closeInstall = document.getElementById('closeInstall');
      
      let musicLibrary = [];
      let filteredLibrary = [];
      let currentTrackIndex = -1;
      let isPlaying = false;
      let isShuffle = false;
      let repeatMode = 0;
      let db;
      let volume = 80;
      let crossfadeEnabled = false;
      let crossfadeSeconds = 3;
      let isCrossfading = false;
      let trackDurations = {};
      let deferredPrompt;
      
      const blobs = document.querySelectorAll('.bg_blob');
      
      let audioContext;
      let analyser;
      let dataArray;
      let bufferLength;
      let visualizerActive = false;
      let animationId;
      const canvasCtx = visualizerCanvas.getContext('2d');
      
      audioPlayer.volume = volume / 100;
      nextAudioPlayer.volume = 0;
      updateVolumeSlider();
      
      initDB();
      
      // PWA Install
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installPrompt.classList.add('show');
      });

      installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            showStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
          }
          deferredPrompt = null;
          installPrompt.classList.remove('show');
        }
      });

      closeInstall.addEventListener('click', () => {
        installPrompt.classList.remove('show');
      });

      window.addEventListener('appinstalled', () => {
        showStatus('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
        installPrompt.classList.remove('show');
      });
      
      addUrlBtn.addEventListener('click', handleUrlAdd);
      urlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUrlAdd();
      });
      
      async function handleUrlAdd() {
        const url = urlInput.value.trim();
        if (!url) {
          showStatus('–í–≤–µ–¥–∏ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–µ–∫', 'error');
          return;
        }
        
        addUrlBtn.disabled = true;
        addUrlBtn.innerHTML = '<span class="loading_spinner"></span> –ó–ê–ì–†–£–ó–ö–ê...';
        
        try {
          if (url.includes('soundcloud.com')) {
            await handleSoundCloudUrl(url);
          } else if (isDirectAudioUrl(url)) {
            await handleDirectAudioUrl(url);
          } else {
            showStatus('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞', 'error');
          }
        } catch (error) {
          console.error('Error adding URL:', error);
          showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ' + error.message, 'error');
        } finally {
          addUrlBtn.disabled = false;
          addUrlBtn.innerHTML = '–î–û–ë–ê–í–ò–¢–¨';
        }
      }
      
      function isDirectAudioUrl(url) {
        const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'];
        const urlLower = url.toLowerCase();
        return audioExtensions.some(ext => urlLower.includes(ext));
      }
      
      async function handleDirectAudioUrl(url) {
        try {
          showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'success');
          
          const response = await fetch(url, { mode: 'cors' });
          if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
          
          const blob = await response.blob();
          
          if (!blob.type.startsWith('audio/')) {
            const ext = url.split('.').pop().split('?')[0].toLowerCase();
            const mimeTypes = {
              'mp3': 'audio/mpeg', 'wav': 'audio/wav', 'ogg': 'audio/ogg',
              'm4a': 'audio/mp4', 'aac': 'audio/aac', 'flac': 'audio/flac'
            };
            
            if (!mimeTypes[ext]) throw new Error('–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞—É–¥–∏–æ');
            const audioBlob = new Blob([blob], { type: mimeTypes[ext] });
            await processUrlAudio(audioBlob, url, 'direct');
          } else {
            await processUrlAudio(blob, url, 'direct');
          }
          
          urlInput.value = '';
          showStatus('–¢—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
          
        } catch (error) {
          throw new Error('–ü—Ä–æ–≤–µ—Ä—å CORS –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–≥—É—é —Å—Å—ã–ª–∫—É');
        }
      }
      
      async function handleSoundCloudUrl(url) {
        try {
          const response = await fetch(`https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(url)}`);
          const data = await response.json();
          
          const track = {
            id: generateId(),
            fileName: data.title + '.soundcloud',
            source: 'soundcloud',
            sourceUrl: url,
            timestamp: Date.now(),
            metadata: {
              title: data.title,
              artist: data.author_name || 'SoundCloud',
              album: 'SoundCloud Stream',
              year: new Date().getFullYear(),
              albumArtUrl: data.thumbnail_url
            },
            audioUrl: url,
            isStream: true
          };
          
          await saveTrackToDB(track);
          musicLibrary.push(track);
          filteredLibrary = [...musicLibrary];
          updateLibraryUI();
          
          urlInput.value = '';
          showStatus('SoundCloud —Ç—Ä–µ–∫ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
          
        } catch (error) {
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ SoundCloud —Ç—Ä–µ–∫–µ');
        }
      }
      
      async function processUrlAudio(audioBlob, sourceUrl, source) {
        const urlParts = sourceUrl.split('/');
        const fileName = decodeURIComponent(urlParts[urlParts.length - 1].split('?')[0]);
        const title = fileName.replace(/\.[^/.]+$/, "").replace(/-|_/g, ' ');
        
        const track = {
          id: generateId(),
          fileName: fileName,
          fileSize: audioBlob.size,
          fileType: audioBlob.type,
          source: source,
          sourceUrl: sourceUrl,
          timestamp: Date.now(),
          metadata: {
            title: title,
            artist: 'Unknown Artist',
            album: 'Web Stream',
            year: new Date().getFullYear(),
            albumArtUrl: null
          },
          audioBlob: audioBlob
        };
        
        await saveTrackToDB(track);
        musicLibrary.push(track);
        filteredLibrary = [...musicLibrary];
        loadTrackDuration(track);
        updateLibraryUI();
        
        if (musicLibrary.length === 1) {
          setTimeout(() => playTrack(0), 500);
        }
      }
      
      function animateBackground() {
        if (!analyser || !isPlaying) {
          requestAnimationFrame(animateBackground);
          return;
        }
        
        analyser.getByteFrequencyData(dataArray);
        
        let sum = 0;
        for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
        const average = sum / bufferLength;
        const intensity = average / 255;
        
        blobs.forEach((blob, index) => {
          const scale = 1 + (intensity * 0.5);
          const opacity = 0.15 + (intensity * 0.15);
          
          const bass = dataArray[Math.floor(index * 3)] / 255;
          const mid = dataArray[Math.floor(bufferLength / 2 + index * 5)] / 255;
          const high = dataArray[Math.floor(bufferLength - 1 - index * 2)] / 255;
          
          let transform = '';
          if (index === 0) {
            transform = `translate(${bass * 30}px, ${mid * 20}px) scale(${scale})`;
          } else if (index === 1) {
            transform = `translate(${-high * 25}px, ${-bass * 30}px) scale(${scale})`;
          } else {
            transform = `translate(${mid * 20}px, ${high * 25}px) scale(${scale})`;
          }
          
          blob.style.transform = transform;
          blob.style.opacity = opacity;
        });
        
        requestAnimationFrame(animateBackground);
      }
      
      animateBackground();
      
      settingsToggle.addEventListener('click', () => {
        settingsPanel.classList.toggle('active');
      });
      
      crossfadeToggle.addEventListener('click', () => {
        crossfadeEnabled = !crossfadeEnabled;
        crossfadeToggle.classList.toggle('active', crossfadeEnabled);
        crossfadeDurationSetting.style.display = crossfadeEnabled ? 'flex' : 'none';
        showStatus(crossfadeEnabled ? '–ö—Ä–æ—Å—Å-—Ñ–µ–π–¥ –≤–∫–ª—é—á–µ–Ω' : '–ö—Ä–æ—Å—Å-—Ñ–µ–π–¥ –≤—ã–∫–ª—é—á–µ–Ω', 'success');
      });
      
      crossfadeDuration.addEventListener('change', (e) => {
        crossfadeSeconds = Math.max(1, Math.min(10, parseInt(e.target.value) || 3));
        e.target.value = crossfadeSeconds;
      });
      
      clearLibraryBtn.addEventListener('click', () => {
        if (musicLibrary.length === 0) return;
        if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${musicLibrary.length} —Ç—Ä–µ–∫–æ–≤?`)) {
          clearLibrary();
        }
      });
      
      async function clearLibrary() {
        try {
          pauseAudio();
          const transaction = db.transaction(['tracks'], 'readwrite');
          const store = transaction.objectStore('tracks');
          const request = store.clear();
          
          request.onsuccess = () => {
            musicLibrary = [];
            filteredLibrary = [];
            currentTrackIndex = -1;
            trackDurations = {};
            resetNowPlayingUI();
            updateLibraryUI();
            showStatus('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
          };
        } catch (error) {
          showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ', 'error');
        }
      }
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        filterTracks(query);
      });
      
      function filterTracks(query) {
        if (!query) {
          filteredLibrary = [...musicLibrary];
          updateLibraryUI();
          return;
        }
        
        filteredLibrary = musicLibrary.filter(track => {
          const title = track.metadata.title.toLowerCase();
          const artist = track.metadata.artist.toLowerCase();
          const album = track.metadata.album.toLowerCase();
          return title.includes(query) || artist.includes(query) || album.includes(query);
        });
        
        updateLibraryUI();
      }
      
      volumeSliderContainer.addEventListener('mousedown', startVolumeSlider);
      
      function startVolumeSlider(e) {
        updateVolumeFromMouse(e);
        document.addEventListener('mousemove', updateVolumeFromMouse);
        document.addEventListener('mouseup', stopVolumeSlider);
      }
      
      function stopVolumeSlider() {
        document.removeEventListener('mousemove', updateVolumeFromMouse);
        document.removeEventListener('mouseup', stopVolumeSlider);
      }
      
      function updateVolumeFromMouse(e) {
        const rect = volumeSliderContainer.getBoundingClientRect();
        const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
        volume = (x / rect.width) * 100;
        audioPlayer.volume = volume / 100;
        nextAudioPlayer.volume = volume / 100;
        updateVolumeSlider();
      }
      
      function updateVolumeSlider() {
        volumeSliderFill.style.width = volume + '%';
        volumeSliderHandle.style.left = volume + '%';
      }
      
      shuffleBtn.addEventListener('click', toggleShuffle);
      repeatBtn.addEventListener('click', toggleRepeat);
      
      function toggleShuffle() {
        isShuffle = !isShuffle;
        shuffleBtn.classList.toggle('active', isShuffle);
        showStatus(isShuffle ? '–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫' : '–ü–æ –ø–æ—Ä—è–¥–∫—É', 'success');
      }
      
      function toggleRepeat() {
        repeatMode = (repeatMode + 1) % 3;
        repeatBtn.classList.toggle('active', repeatMode > 0);
        const modes = ['–ü–æ–≤—Ç–æ—Ä –≤—ã–∫–ª—é—á–µ–Ω', '–ü–æ–≤—Ç–æ—Ä –≤—Å–µ—Ö', '–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞'];
        repeatBtn.innerHTML = repeatMode === 2 ? '<span>‚ü≤1</span>' : '<span>‚ü≤</span>';
        showStatus(modes[repeatMode], 'success');
      }
      
      visualizerToggle.addEventListener('click', toggleVisualizer);
      
      function toggleVisualizer() {
        visualizerActive = !visualizerActive;
        visualizerToggle.classList.toggle('active', visualizerActive);
        visualizerCanvas.classList.toggle('active', visualizerActive);
        
        if (visualizerActive) {
          initAudioContext();
          drawVisualizer();
        } else {
          if (animationId) cancelAnimationFrame(animationId);
        }
      }
      
      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          const source = audioContext.createMediaElementSource(audioPlayer);
          source.connect(analyser);
          analyser.connect(audioContext.destination);
          analyser.fftSize = 64;
          bufferLength = analyser.frequencyBinCount;
          dataArray = new Uint8Array(bufferLength);
        }
      }
      
      function drawVisualizer() {
        if (!visualizerActive) return;
        
        animationId = requestAnimationFrame(drawVisualizer);
        analyser.getByteFrequencyData(dataArray);
        
        canvasCtx.fillStyle = '#121212';
        canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
        
        const barWidth = visualizerCanvas.width / bufferLength;
        let x = 0;
        
        for (let i = 0; i < bufferLength; i++) {
          const barHeight = (dataArray[i] / 255) * visualizerCanvas.height;
          canvasCtx.fillStyle = '#9ea3a8';
          canvasCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth - 1, barHeight);
          x += barWidth;
        }
      }
      
      dragDropArea.addEventListener('click', () => {
        const tempInput = document.createElement('input');
        tempInput.type = 'file';
        tempInput.accept = 'audio/*';
        tempInput.multiple = true;
        tempInput.addEventListener('change', handleFileSelect);
        tempInput.click();
      });
      
      dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragDropArea.classList.add('drag_over');
      });
      
      dragDropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragDropArea.classList.remove('drag_over');
      });
      
      dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragDropArea.classList.remove('drag_over');
        
        const files = Array.from(e.dataTransfer.files);
        const audioFiles = files.filter(file => file.type.startsWith('audio/'));
        
        if (audioFiles.length > 0) {
          processAudioFiles(audioFiles);
        } else {
          showStatus('–í—ã–±–µ—Ä–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª—ã', 'error');
        }
      });
      
      playBtn.addEventListener('click', playCurrentTrack);
      pauseBtn.addEventListener('click', pauseAudio);
      prevBtn.addEventListener('click', playPreviousTrack);
      nextBtn.addEventListener('click', playNextTrack);
      
      audioPlayer.addEventListener('loadedmetadata', () => {
        updateDuration();
        const track = musicLibrary[currentTrackIndex];
        if (track) {
          trackDurations[track.id] = audioPlayer.duration;
          updateLibraryUI();
        }
      });
      
      audioPlayer.addEventListener('timeupdate', updateProgress);
      audioPlayer.addEventListener('ended', handleTrackEnded);
      
      progressBar.addEventListener('mousedown', startProgressDrag);
      
      function startProgressDrag(e) {
        seekAudio(e);
        document.addEventListener('mousemove', seekAudio);
        document.addEventListener('mouseup', stopProgressDrag);
      }
      
      function stopProgressDrag() {
        document.removeEventListener('mousemove', seekAudio);
        document.removeEventListener('mouseup', stopProgressDrag);
      }
      
      function handleTrackEnded() {
        if (repeatMode === 2) {
          audioPlayer.currentTime = 0;
          playCurrentTrack();
        } else {
          playNextTrack();
        }
      }
      
      function initDB() {
        const request = indexedDB.open('MusicPlayerDB', 2);
        
        request.onerror = () => {
          showStatus('–û—à–∏–±–∫–∞ –ë–î', 'error');
        };
        
        request.onsuccess = (event) => {
          db = event.target.result;
          loadLibraryFromDB();
        };
        
        request.onupgradeneeded = (event) => {
          const database = event.target.result;
          if (!database.objectStoreNames.contains('tracks')) {
            const store = database.createObjectStore('tracks', { keyPath: 'id' });
            store.createIndex('timestamp', 'timestamp', { unique: false });
          }
        };
      }
      
      function loadLibraryFromDB() {
        const transaction = db.transaction(['tracks'], 'readonly');
        const store = transaction.objectStore('tracks');
        const request = store.getAll();
        
        request.onsuccess = (event) => {
          const tracks = event.target.result;
          if (tracks.length > 0) {
            musicLibrary = tracks;
            filteredLibrary = [...musicLibrary];
            
            musicLibrary.forEach(track => {
              if (!track.isStream) loadTrackDuration(track);
            });
            
            updateLibraryUI();
            showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${tracks.length} —Ç—Ä–µ–∫–æ–≤`, 'success');
          }
        };
      }
      
      function loadTrackDuration(track) {
        if (trackDurations[track.id] || track.isStream) return;
        
        const tempAudio = new Audio();
        tempAudio.src = URL.createObjectURL(track.audioBlob);
        tempAudio.addEventListener('loadedmetadata', () => {
          trackDurations[track.id] = tempAudio.duration;
          updateLibraryUI();
          URL.revokeObjectURL(tempAudio.src);
        });
      }
      
      function saveTrackToDB(track) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(['tracks'], 'readwrite');
          const store = transaction.objectStore('tracks');
          const request = store.add(track);
          
          request.onsuccess = () => resolve();
          request.onerror = (event) => reject(event.target.error);
        });
      }
      
      function deleteTrackFromDB(trackId) {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(['tracks'], 'readwrite');
          const store = transaction.objectStore('tracks');
          const request = store.delete(trackId);
          
          request.onsuccess = () => resolve();
          request.onerror = (event) => reject(event.target.error);
        });
      }
      
      function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        if (files.length > 0) processAudioFiles(files);
      }
      
      async function processAudioFiles(files) {
        let newTracks = 0;
        
        for (const file of files) {
          const existingTrack = musicLibrary.find(track => 
            track.fileName === file.name && track.fileSize === file.size
          );
          
          if (existingTrack) {
            showStatus(`"${file.name}" —É–∂–µ –µ—Å—Ç—å`, 'error');
            continue;
          }
          
          try {
            const metadata = await extractMetadata(file);
            const audioBlob = new Blob([file], { type: file.type });
            
            const track = {
              id: generateId(),
              fileName: file.name,
              fileSize: file.size,
              fileType: file.type,
              lastModified: file.lastModified,
              timestamp: Date.now(),
              source: 'local',
              metadata: metadata,
              audioBlob: audioBlob
            };
            
            await saveTrackToDB(track);
            musicLibrary.push(track);
            loadTrackDuration(track);
            newTracks++;
            
          } catch (error) {
            console.error('Error:', error);
          }
        }
        
        if (newTracks > 0) {
          filteredLibrary = [...musicLibrary];
          updateLibraryUI();
          showStatus(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${newTracks}`, 'success');
          
          if (musicLibrary.length === newTracks) {
            setTimeout(() => playTrack(0), 500);
          }
        }
      }
      
      function extractMetadata(file) {
        return new Promise((resolve) => {
          try {
            window.jsmediatags.read(file, {
              onSuccess: function(tag) {
                const { tags } = tag;
                
                const title = tags.title || file.name.replace(/\.[^/.]+$/, "");
                const artist = tags.artist || 'Unknown Artist';
                const album = tags.album || 'Unknown Album';
                const year = tags.year || 'Unknown';
                
                let albumArtUrl = null;
                if (tags.picture) {
                  const picture = tags.picture;
                  const base64String = arrayBufferToBase64(picture.data);
                  albumArtUrl = `data:${picture.format};base64,${base64String}`;
                }
                
                resolve({ title, artist, album, year, albumArtUrl });
              },
              onError: function() {
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                resolve({
                  title: fileName,
                  artist: 'Unknown Artist',
                  album: 'Unknown Album',
                  year: 'Unknown',
                  albumArtUrl: null
                });
              }
            });
          } catch (error) {
            const fileName = file.name.replace(/\.[^/.]+$/, "");
            resolve({
              title: fileName,
              artist: 'Unknown Artist',
              album: 'Unknown Album',
              year: 'Unknown',
              albumArtUrl: null
            });
          }
        });
      }
      
      function updateLibraryUI() {
        const displayLibrary = searchInput.value.trim() ? filteredLibrary : musicLibrary;
        trackCount.textContent = `${displayLibrary.length} ${displayLibrary.length === 1 ? '—Ç—Ä–µ–∫' : displayLibrary.length < 5 ? '—Ç—Ä–µ–∫–∞' : '—Ç—Ä–µ–∫–æ–≤'}`;
        trackList.innerHTML = '';
        
        if (displayLibrary.length === 0) {
          trackList.innerHTML = `
            <div class="empty_library">
              <p>${searchInput.value.trim() ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø—É—Å—Ç–∞'}</p>
              <p class="empty_hint">${searchInput.value.trim() ? '–ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å' : '–î–æ–±–∞–≤—å —Ç—Ä–µ–∫–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª—ã'}</p>
            </div>
          `;
          return;
        }
        
        displayLibrary.forEach((track) => {
          const actualIndex = musicLibrary.indexOf(track);
          const trackElement = document.createElement('div');
          trackElement.className = 'track_item';
          if (actualIndex === currentTrackIndex) {
            trackElement.classList.add('active');
          }
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete_btn';
          deleteBtn.innerHTML = '√ó';
          deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteTrack(actualIndex);
          });
          
          const duration = trackDurations[track.id] ? formatTime(trackDurations[track.id]) : (track.isStream ? 'STREAM' : '--:--');
          
          let sourceBadge = '';
          if (track.source === 'soundcloud') {
            sourceBadge = '<span class="track_source_badge platform_soundcloud">SC</span>';
          } else if (track.source === 'direct') {
            sourceBadge = '<span class="track_source_badge platform_direct">URL</span>';
          }
          
          trackElement.innerHTML = `
            <div class="track_art">
              ${track.metadata.albumArtUrl 
                ? `<img src="${track.metadata.albumArtUrl}" alt="${track.metadata.album}" />` 
                : '<div>‚ô´</div>'}
              ${sourceBadge}
            </div>
            <div class="track_info">
              <div class="track_title">${track.metadata.title}</div>
              <div class="track_artist">${track.metadata.artist}</div>
              <div class="track_album">${track.metadata.album}</div>
            </div>
            <div class="track_duration">${duration}</div>
          `;
          
          trackElement.appendChild(deleteBtn);
          trackElement.addEventListener('click', () => playTrack(actualIndex));
          trackList.appendChild(trackElement);
        });
      }
      
      async function deleteTrack(index) {
        const track = musicLibrary[index];
        if (!track) return;
        
        try {
          await deleteTrackFromDB(track.id);
          delete trackDurations[track.id];
          musicLibrary.splice(index, 1);
          
          if (currentTrackIndex === index) {
            pauseAudio();
            currentTrackIndex = -1;
            resetNowPlayingUI();
          } else if (currentTrackIndex > index) {
            currentTrackIndex--;
          }
          
          filteredLibrary = [...musicLibrary];
          filterTracks(searchInput.value.toLowerCase().trim());
          showStatus('–¢—Ä–µ–∫ —É–¥–∞–ª–µ–Ω', 'success');
        } catch (error) {
          showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        }
      }
      
      function playTrack(index) {
        if (index < 0 || index >= musicLibrary.length) return;
        
        const track = musicLibrary[index];
        currentTrackIndex = index;
        
        isCrossfading = false;
        nextAudioPlayer.pause();
        nextAudioPlayer.src = '';
        
        if (track.isStream && track.source === 'soundcloud') {
          showStatus('SoundCloud —Ç—Ä–µ–∫–∏ —Ç—Ä–µ–±—É—é—Ç –≤–∏–¥–∂–µ—Ç', 'error');
          return;
        }
        
        if (track.audioBlob) {
          const objectURL = URL.createObjectURL(track.audioBlob);
          audioPlayer.src = objectURL;
        } else if (track.audioUrl) {
          audioPlayer.src = track.audioUrl;
        }
        
        audioPlayer.volume = volume / 100;
        
        updateNowPlayingUI(track);
        updateLibraryUI();
        playCurrentTrack();
      }
      
      function playCurrentTrack() {
        if (currentTrackIndex === -1 && musicLibrary.length > 0) {
          playTrack(0);
          return;
        }
        
        if (currentTrackIndex >= 0) {
          audioPlayer.play().then(() => {
            isPlaying = true;
            updatePlayPauseButtons();
            if (audioContext) audioContext.resume();
          }).catch(error => {
            showStatus('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è', 'error');
          });
        }
      }
      
      function pauseAudio() {
        audioPlayer.pause();
        isPlaying = false;
        updatePlayPauseButtons();
      }
      
      function playPreviousTrack() {
        if (musicLibrary.length === 0) return;
        let newIndex = currentTrackIndex - 1;
        if (newIndex < 0) newIndex = musicLibrary.length - 1;
        playTrack(newIndex);
      }
      
      function playNextTrack() {
        if (musicLibrary.length === 0) return;
        const nextIndex = getNextTrackIndex();
        if (nextIndex === -1) {
          pauseAudio();
          return;
        }
        playTrack(nextIndex);
      }
      
      function getNextTrackIndex() {
        if (musicLibrary.length === 0) return -1;
        
        if (repeatMode === 2) {
          return currentTrackIndex;
        } else if (isShuffle) {
          let newIndex = Math.floor(Math.random() * musicLibrary.length);
          if (musicLibrary.length > 1) {
            while (newIndex === currentTrackIndex) {
              newIndex = Math.floor(Math.random() * musicLibrary.length);
            }
          }
          return newIndex;
        } else {
          let newIndex = currentTrackIndex + 1;
          if (newIndex >= musicLibrary.length) {
            return repeatMode === 1 ? 0 : -1;
          }
          return newIndex;
        }
      }
      
      function seekAudio(event) {
        if (!audioPlayer.duration) return;
        
        const progressBar = event.currentTarget || document.getElementById('progressBar');
        const rect = progressBar.getBoundingClientRect();
        const clickPosition = event.clientX - rect.left;
        const progressBarWidth = rect.width;
        const seekTime = (clickPosition / progressBarWidth) * audioPlayer.duration;
        
        audioPlayer.currentTime = Math.max(0, Math.min(seekTime, audioPlayer.duration));
      }
      
      function updateNowPlayingUI(track) {
        musicInfo.innerHTML = `
          <span class="song_title">${track.metadata.title}</span>
          <span class="artist_name">${track.metadata.artist}</span>
          <span class="album_name">${track.metadata.album}</span>
        `;
        
        if (track.metadata.albumArtUrl) {
          albumArt.className = 'main_image';
          albumArt.style.backgroundImage = `url(${track.metadata.albumArtUrl})`;
          albumArt.style.backgroundSize = 'cover';
          albumArt.style.backgroundPosition = 'center';
          albumArt.textContent = '';
        } else {
          albumArt.className = 'main_image default-art';
          albumArt.style.backgroundImage = '';
          albumArt.textContent = '‚ô´';
        }
        
        progressContainer.style.display = 'block';
      }
      
      function resetNowPlayingUI() {
        musicInfo.innerHTML = `
          <span class="song_title">–¢—Ä–µ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
          <span class="artist_name">–í—ã–±–µ—Ä–∏ —Ç—Ä–µ–∫</span>
          <span class="album_name">–¢–≤–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</span>
        `;
        
        albumArt.className = 'main_image default-art';
        albumArt.style.backgroundImage = '';
        albumArt.textContent = '‚ô´';
        
        progressContainer.style.display = 'none';
      }
      
      function updatePlayPauseButtons() {
        if (isPlaying) {
          playBtn.style.display = 'none';
          pauseBtn.style.display = 'block';
        } else {
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        }
      }
      
      function updateDuration() {
        const duration = audioPlayer.duration;
        durationEl.textContent = formatTime(duration);
      }
      
      function updateProgress() {
        const currentTime = audioPlayer.currentTime;
        const duration = audioPlayer.duration;
        
        if (duration) {
          const progressPercent = (currentTime / duration) * 100;
          progressFill.style.width = `${progressPercent}%`;
          progressHandle.style.left = `${progressPercent}%`;
          currentTimeEl.textContent = formatTime(currentTime);
        }
      }
      
      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status_message status_${type}`;
        statusMessage.style.display = 'block';
        
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 4000);
      }
      
      function formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
      }
      
      function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
      }
      
      function generateId() {
        return '_' + Math.random().toString(36).substr(2, 9) + Date.now();
      }
      
      updateLibraryUI();
      updatePlayPauseButtons();
    });
  </script>
</body>
</html>
